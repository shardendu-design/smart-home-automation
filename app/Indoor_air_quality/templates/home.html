{% extends 'layout.html' %}

{% block content %}
    <h1>Weather Data Zone</h1>
    <table id="weather-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Temperature</th>
                <th>Feels like</th>
                <th>Pressure</th>
                <th>Humidity</th>
                <th>Visibility</th>
                <th>Wind Speed</th>
                <th>City Name</th>
                <th>Country Code</th>
            </tr>
        </thead>
        <tbody>
            {% for data in weather_data %}
                <tr>
                    <td>{{ data['Timestamp'] }}</td>
                    <td>{{ data['Temperature'] }}</td>
                    <td>{{ data['Feels like'] }}</td>
                    <td>{{ data['Pressure'] }}</td>
                    <td>{{ data['Humidity'] }}</td>
                    <td>{{ data['Visibility'] }}</td>
                    <td>{{ data['Wind Speed'] }}</td>
                    <td>{{ data['City Name'] }}</td>
                    <td>{{ data['Country Code'] }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- <h1>Weather Data Graph</h1>
    <div class="graph-container">
        <canvas id="weatherChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('weatherChart').getContext('2d');
        let weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Timestamps will be set here
                datasets: [
                    {
                        label: 'Temperature',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Humidity',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Pressure',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Visibility',
                        data: [],
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Wind Speed',
                        data: [],
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function updateGraphAndTable() {
        fetch('/weather-data')
            .then(response => response.json())
            .then(data => {
                console.log('Fetched weather data:', data); // Debugging log
                if (data && data.length > 0) {
                    // Update Graph
                    weatherChart.data.labels = data.map(item => item.Timestamp);
                    weatherChart.data.datasets[0].data = data.map(item => item.Temperature);
                    weatherChart.data.datasets[1].data = data.map(item => item.Humidity);
                    weatherChart.data.datasets[2].data = data.map(item => item.Pressure);
                    weatherChart.data.datasets[3].data = data.map(item => item.Visibility);
                    weatherChart.data.datasets[4].data = data.map(item => item['Wind Speed']);
                    weatherChart.update();
                }
            })
            .catch(error => {
                console.error('Error fetching weather data:', error);
                console.log('Fetch error:', error); // Debugging log
            });
    }

    updateGraphAndTable(); // Initial call to load the graph and table
    </script> -->

    <h1>Indoor Air Quality Metrics</h1>
    <table id="iaq-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Temperature</th>
                <th>Humidity</th>
                <th>CO2</th>
                <th>VOC</th>
                <th>PM2.5</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            {% for data in sensor_data %}
            <tr>
                <td>{{ data['timestamp'] }}</td>
                <td>{{ data['temp'] }}</td>
                <td>{{ data['humid'] }}</td>
                <td>{{ data['co2'] }}</td>
                <td>{{ data['voc'] }}</td>
                <td>{{ data['pm25'] }}</td>
                <td>{{ data['location'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h1>Machine Learning Prediction</h1>
    <table id="prediction" border="1">
        <tr>
            {% for header in headers %}
                <th>{{ header }}</th>
            {% endfor %}
        </tr>
        <tr>
            {% for value in recent_row %}
                {% if loop.index in [0, 2, 3, 4, 5, 6, 7, 8, 9, 10] %}
                    {% if value|float is defined %}
                        <td>{{ '%.2f'|format(value|float) }}</td>
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %}
                {% else %}
                    <td>{{ value }}</td>
                {% endif %}
            {% endfor %}
        </tr>
    </table>

    <h1>Predicted Graph</h1>

    <div class="graph-container"> <!-- Adjust size here -->
        <canvas id="myChart"></canvas>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CO2 Prediction',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Humidity Prediction',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'PM2.5 Prediction',
                        data: [],
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Temperature Prediction',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'VOC Prediction',
                        data: [],
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        function updateGraphAndTables() {
            fetch('/latest-data')
                .then(response => response.json())
                .then(data => {
                    if(data && data.length > 0) {
                        chart.data.labels = data.map(item => item.DateTime);
                        chart.data.datasets[0].data = data.map(item => item.Co2_Pred);
                        chart.data.datasets[1].data = data.map(item => item.Humid_Pred);
                        chart.data.datasets[2].data = data.map(item => item.Pm25_Pred);
                        chart.data.datasets[3].data = data.map(item => item.Temp_Pred);
                        chart.data.datasets[4].data = data.map(item => item.VOC_Pred);
                        chart.update();
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }
        
        setInterval(updateGraphAndTables, 5000);
    </script>

{% endblock %}
